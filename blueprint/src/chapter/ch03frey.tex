\chapter{Elliptic curves, and the Frey Curve}

\section{Overview}

In the last chapter we explained how, given a counterexample to Fermat's Last Theorem we could construct a Frey package and thus a Frey curve, which is an elliptic curve with some interesting properties. In this chapter we start with an overview of parts of the theory of the arithmetic of elliptic curves. Following
this we prove the two main results of this chapter: firstly that the $p$-torsion $\rho$ in the Frey curve is ``hardly ramified'', and secondly that Mazur's result on the possible torsion of elliptic curves implies that $\rho$ must be irreducible.

\section{The arithmetic of elliptic curves}

We give an overview of the results we need, citing the literature for proofs. Everything here is
 standard, and mostof it dates back to the 1970s or before.

\begin{theorem}\label{Elliptic_curve_n_torsion_size}\lean{EllipticCurve.n_torsion_card}\tangled\discussion{12345}
  Let $n$ be a positive integer, let $K$ be a separably closed
  field with $n$ nonzero in $K$, and let $E$ be an elliptic curve over $K$. Then the $n$-torsion $E(K)[n]$ 
  in the $K$-points of $E$ is a finite group of size $n^2$.
\end{theorem}
\begin{proof}
  There are several proofs in the textbooks {\bf TODO precise reference}. We shall prove this result using the theory of division polynomials; the formalisation is ongoing work of David Angdinata, and it will be part of his PhD thesis.
\end{proof}

This theorem actually tells us the structure of the $n$-torsion, because of the following
purely group-theoretic result:
\begin{lemma}\label{group_theory_lemma}
  If $n$ is a positive integer and $A$ is a finite
  abelian group of size $n^2$ and if for all $d\mid n$, the $d$-torsion in $A$ has size $d^2$, 
  then $A\cong (\Z/n\Z)^2$. 
\end{lemma}
\begin{proof}
  The result is obvious if $n=1$, so we may assume $n.1$. One proof would be to write $A$ as $\prod_{i=1}^t(\Z/a_i\Z)$
  with $a_i\mid a_{i+1}$ (this is possible by the structure theorem of finite abelian groups), and then to apply our hypothesis firstly with $d=a_1$ to deduce $t=2$ and then with $d=a_2$ to deduce $a_1=a_2$.
\end{proof}

\begin{corollary}\label{Elliptic_curve_n_torsion_2d}\lean{EllipticCurve.n_torsion_dimension}
  Let $n$ be a positive integer, let $K$ be a separably closed
  field with $n$ nonzero in $K$, and let $E$ be an elliptic curve over $K$. Then the $n$-torsion $E(K)[n]$ 
  in the $K$-points of $E$ is a finite group isomorphic to $(\Z/n\Z)^2$.
\end{corollary}
\begin{proof}
  This follows from the previous group-theoretic lemma~\ref{group_theory_lemma} and
  theorem~\ref{Elliptic_curve_n_torsion_size}.
\end{proof}

We saw in section~\ref{twopointfour} that if if $E$ is an elliptic curve over a field $K$,
then $\GK$ acts naturally on the abelian group $E(K^{\sep})[n]$. If furthermore $n\not=0$ in $K$ then from the above corollary, we now know that this abelian group is free of rank 2 over $\Z/n\Z$. If we choose a basis (this is traditionally done in the literature, although we do not ever seem to actually use such a choice), then $E(K^{\sep})[n]$ gives us a \emph{Galois representation} $\GK\to\GL_2(\Z/n\Z)$.

A fundamental fact about this Galois representation is that its determinant is the
cyclotomic character.

\begin{theorem}\label{Elliptic_curve_det_n_torsion}\uses{Elliptic_curve_n_torsion_2d} If $E$ is an elliptic curve over a field $K$, and $n>0$ is a positive integer which is nonzero in $K$, then the determinant of the 2-dimensional representation of $\Gal(K^{\sep}/K)$ on $E[n]$ is the 
  mod $n$ cyclotomic character.
\end{theorem}
\begin{proof}
  This presumably should be done via the Weil pairing. I have not yet put any thought into a feasible way to formalise this.
\end{proof}

\section{Good reduction}

We give a brief overview of the theory of good and multiplicative reduction of elliptic curves.
For more details one can consult the standard sources such as~\cite{silverman1}. **TODO** more
precise ref. We stick with the low-level approach, thinking of elliptic curves as plane cubics; whilst we cannot do this forever, it will suffice for these initial results.

\begin{definition}\label{good_reduction} Let $E$ be an elliptic curve over the field of fractions $K$ of a DVR
$R$ with maximal ideal $\m$. We say $E$ has \emph{good reduction} if $E$ has a model with 
coefficients in $R$ and the reduction mod $\m$ is still non-singular. If $E$ is an elliptic curve 
over a number field $N$ and $P$ is a finite place of $N$, then one says that $E$ has \emph{good reduction at $P$} if 
the base extension of $E$ to the completion $N_P$ of $N$ at $P$ has good reduction.
\end{definition}

\begin{remark} From this point on, our Frey curves and Frey packages will use notation $(a,b,c,\ell)$, with $\ell\geq 5$ a prime number. This frees up $p$ for use as another prime.
\end{remark}

\begin{example} If $E$ is the Frey curve $Y^2=X(X-a^\ell)(X+b^\ell)$ associated to a
  Frey package $(a,b,c,\ell)$, and if $p$ is a prime
  not dividing $abc$ (and in particular if $p>2$), then the reduction mod $p$ of this 
  equation is still a smooth
  plane cubic, because the three roots $0$, $a^\ell$ and $-b^\ell$ are distinct modulo $p$
  (note that the difference between $a^\ell$ and $-b^\ell$ is $c^\ell$). Hence the Frey curve
  has good reduction at $\ell$.
\end{example}

If $E$ is an elliptic curve over a number field $N$ and if $\rho$ is the representation
of $\Gal(\overline{N}/N)$ on the $n$-torsion of $E$ then $\rho$ is continuous and its image is finite,
so by the fundamental theorem of (infinite) Galois theory the representation factors through an
injection $\Gal(L/N)\to\GL_2(\Z/n\Z)$ where $L/N$ is a finite Galois extension of
number fields. One says that $\rho$ is \emph{unramified} at a finite place $P$ of $N$
if the extension $L/N$ is unramified at $P$ (or in other words, if the factorization
of $P$ in the integers of $L$ is squarefree).

At some point we will need a theory of finite flat group schemes over an affine base. Here
is a working definition. {\bf TODO should be locally free not flat}

\begin{definition}\label{finite_flat_group_scheme} If $R$ is a commutative ring, then
  a \emph{finite flat group scheme} over $R$ is the spectrum of a commutative Hopf algebra $H/R$ 
  which is finite and flat as an $R$-module.
\end{definition}


Some facts we will need are:

\begin{theorem}\label{good_reduction_implies_unramified} If $E$ is an ellipitic curve over a number 
  field $N$ and $E$ has good reduction at a finite place $P$ of $N$, and if furthermore 
  $n\not\in P$, then the Galois representation on the $n$-torsion of $E$ is unramified.
\end{theorem}
\begin{proof}
  One approach to this would be by developing the theory of finite flat group schemes
  and considering the $n$-torsion on a good integral model for $E$. I have not really thought
  through whether this is the best approach. 
\end{proof}

\begin{theorem}\label{good_reduction_implies_flat} If $E$ is an ellipitic curve over a number field 
  $N$ and $E$ has good reduction at a finite place $P$ of $N$ containing the prime number $p$, 
  then the Galois representation on the $\ell$-torsion of $E$ comes from a finite flat group scheme 
  over the integers of the completion $N_P$.
\end{theorem}
\begin{proof}
  Indeed, the kernel of the $p$-torsion on a good integral model is finite and flat.
  Checking this claim formally will involve a fair amount of work.
\end{proof}

\section{Multiplicative reduction}

If $E$ is an elliptic curve over the field of fractions $K$ of a DVR $R$ with maximal ideal $\m$,
then we say that $E$ has \emph{multiplicative reduction} if there is an integral model of $E$
which reduces mod $R/\m$ to a plane cubic with only one singularity, which is an ordinary double point.
We say that the reduction is \emph{split} if the two tangent lines at the ordinary double point
are both defined over $R/\m$, and \emph{non-split} otherwise.

\begin{example} If $E$ is the Frey curve $Y^2=X(X-a^\ell)(X+b^\ell)$ associated to a Frey
  package $(a,b,c,\ell)$, and if $p$ is an odd prime
  which divides $abc$, then the reduction mod $p$ of this equation is smooth
  away from the point $(x,0)$ where $x$ is the double root of the cubic mod $p$,
  and has an ordinary double point at $(x,0)$. Hence the Frey curve has
  multiplicative reduction at $p$.
\end{example}

\begin{example} If $E$ is the Frey curve $Y^2=X(X-a^\ell)(X+b^\ell)$ associated to a Frey package
  $(a,b,c,\ell)$ then $E$ has multiplicative reduction at 2. For the change of variables $X=4X'$ 
  and $Y=8Y'+4X'$ changes the equation to 
  $64Y'^2+64X'Y'=64X'^3+16X'^2(b^\ell-a^\ell-1)-4X'a^\ell b^\ell$ and, because $\ell\geq5$,
  $b$ is even and $a=3$ mod 4, we see that the 64s cancel, giving an equation which reduces mod 2 to
  $Y'^2+X'Y'=X'^3+cX'^2$ for some $c\in\{0,1\}$. This cubic is smooth away from an ordinary 
  double point at $(0,0)$. Hence the Frey curve has multiplicative reduction at~2. Note
  that $c=0$ iff $E$ has split multiplicative reduction (which happens iff $a^\ell=7$ mod $8$).
\end{example}

In particular, the Frey curve associated to a Frey package is \emph{semistable} -- it has good or
 multiplicative reduction at all primes.

The main thing we need about elliptic curves with multiplicative reduction over nonarchimedean
local fields is the \emph{uniformisation theorem}, originally due to Tate. 

\begin{theorem}\label{Tate_curve_uniformisation} If $E$ is an elliptic curve over a field
  complete with respect to a nontrivial nonarchimedean (real-valued) norm $K$ amd if $E$ has split
  multiplicative reduction, then there is a Galois-equivariant injection
  $(K^{\sep})^\times/q^{\mathbb{Z}}\to E(K^{\sep})$, where $q\in K^\times$ satisfies
  $|q|=|j(E)|^{-1}$.
\end{theorem}
\begin{proof}
  See~\cite{silverman2}, Theorems V.3.1, Remark V.3.1.2 (we don't need surjectivity),
  and Theorem V.5.3. {**TODO** check claim about $|q|$ and $|j|$ is there}
\end{proof}

\begin{corollary}\label{multiplicative_reduction_torsion} If $E$ is an elliptic curve
  over a field $K$ complete with respect to a nontrivial nonarchimedean (real-valued) norm
  and with perfect residue field, and if $E$ has multiplicative reduction, then there's
  an unramified character $\chi$ of $\Gal(K^{\sep}/K)$ whose square is 1, such that for
  all positive integers $n$ with $n\not=0$ in $K$, the 
  $n$-torsion $E(K^{\sep})[n]$ is an extension of $\chi$ by $\epsilon\chi$, where $\epsilon$ is the
  cyclotomic character.
\end{corollary}
\begin{proof} After a quadratic twist we may assume that $E$ has split multiplicative reduction.
  The result then follows from the uniformisation theorem and an explicit computation.
  Note that even if we do not prove surjectivity of Tate's uniformisation, we still know
  that it's surjective on the $n$-torsion, because all $n^2$ point in the $n$-torsion of $E$
  are accounted for by the $n$-torsion in $(K^{\sep})^\times/q^{\mathbb{Z}}$.
\end{proof}

\section{Hardly ramified representations}

We make the following definition; this is not in the literature but it is a useful concept for us.

\begin{definition}\label{hardly_ramified} Let $\ell\geq5$ be a prime and let $V$ be a
  2-dimensional vector space over $\Z/\ell\Z$. A representation 
  $\rho: \GQ\to \GL(V)$ is said to be \emph{hardly ramified} if it satisfies the following four axioms:
  \begin{enumerate}
  \item $\det(\rho)$ is the mod $\ell$ cyclotomic character;
  \item $\rho$ is unramified outside $2\ell$;
  \item The semisimplification of the restriction of $\rho$ to $\Gal(\Qbar_2/\Q_2)$ is unramified;
  \item The restriction of $\rho$ to $\GQl$ comes from a finite flat group scheme.
  \end{enumerate}
\end{definition}

We are interested in hardly ramified representations for several reasons. One is that by using some 
deep theorems, we will be able to prove that all hardly ramified representations are 
\emph{potentially automorphic}, which will give us our first foothold into the world of modular 
forms. We shall come back to these ideas later. In this section we shall be concerned with
the following rather simpler result, namely that the $\ell$-torsion in the Frey curve
associated to a Frey package $(a,b,c,\ell)$ is hardly ramified. The rest of this chapter is 
devoted to a proof of this. The proof is standard; for another reference, see Theorem~2.15
of~\cite{ddt}.

\section{The l-torsion in the Frey curve is hardly ramified.}

Let $(a,b,c,\ell)$ be a Frey package, with associated Frey curve $E$ and mod $\ell$ Galois
 representation $\rho=E[\ell]$. We now work through a proof that $\rho$ is hardly ramified.

 \begin{theorem}\label{Frey_curve_good} If $p\not=\ell$ is a prime not dividing $abc$ then
  $\rho$ is unramified at~$p$.
 \end{theorem}
 \begin{proof} Indeed, $E$ has good reduction at $p$, and hence $\rho$ is unramified at $p$ 
  by~\ref{good_reduction_implies_unramified}. 
 \end{proof}

If however $p$ divides $abc$ then $E$ has multiplicative 
reduction at $p$, and we can use the theory of the Tate curve to analyse $\rho$ at $p$.

\begin{theorem}\label{Frey_curve_j} If $(a,b,c,\ell)$ is a Frey package then the $j$-invariant of the corresponding Frey curve is $2^8(C^2-AB)^3/A^2B^2C^2$, where $A=a^\ell$, $B=b^\ell$ and $C=c^\ell$.
\end{theorem}
\begin{proof}
  Apply the explicit formula (presumably already in mathlib)
\end{proof}

\begin{corollary}\label{Frey_curve_unram} If $(a,b,c,\ell)$ is a Frey package, if $2<p\mid abc$
  is a prime with $p\not=\ell$, then the $\ell$-torsion in the Frey curve is unramified
  at $p$.
\end{corollary}
\begin{proof} After an unramified quadratic twist we may assume the curve is split at $p$.
  The theory of the Tate curve tells us that the extension of $\Q_p$ cut out by the $\ell$-torsion
  of the Frey curve is $\Q_p(\mu_\ell,\sqrt[l]{q})$. Because $\ell\not=p$ the extension
  $\Q_p(\mu_\ell)$ is unramified at $p$. And because $p\not=2$ divides $abc$, 
  theorem~\ref{Frey_curve_j} shows us that the $j$-invariant of the Frey curve has $p$-adic
  valuation a power of $\ell$. Thus the extension can be written $\Q_p(\mu_\ell,\sqrt[l]{u})$,
  where $u\in\Q_p^\times$ is a unit. The extension is hence unramified (because, for example,
  Hensel's Lemma shows that the $\ell$th root of $u$ is in the maximal unramified
  extension of $\Q_p$).
\end{proof}

\begin{corollary}\label{frey_curve_unramified} If $(a,b,c,\ell)$ is a Frey package, then the $\ell$-torsion in the Frey curve is unramified at all primes $p\not=2,\ell$.
\end{corollary}

This analysis needs to be slightly modified if $p=2$, because the $j$-invariant of
the Frey curve may not have 2-adic valuation a multiple of $\ell$. We obtain the
following weaker result.

\begin{corollary}\label{frey_curve_at_2} If $(a,b,c,\ell)$ is a Frey package, then the 
  semisimplification of the restriction of the $\ell$-torsion $\rho$ in the associated Frey curve 
  to $\Gal(\Qbar_2/\Q_2)$ is unramified.
\end{corollary}
\begin{proof} After a quadratic twist to make the curve have split multiplicative
  reduction, the theory of the Tate curve shows us that $\rho$ is an extension
  of the trivial character by the cyclotomic character. The extension is controlled
  by the $\ell$th root of $q$, which we can say little about, however we do know
  that the semisimplification of this representation is the direct sum of two
  unramified characters and is hence unramified.
\end{proof}

\begin{theorem}\label{Frey_curve_mod_ell_rep_at_ell} Let $\rho$ be the $\ell$-torsion in the
  Frey curve associated to a Frey package $(a,b,c,\ell)$. Then the restriction of $\rho$ to $\GQl$ comes from a finite flat group scheme.
\end{theorem}
\begin{proof} The Frey curve either has good reduction at $\ell$ (case 1 of FLT) or multiplicative 
  reduction at $\ell$ (case 2 of FLT). In the first case the $\ell$-torsion is finite and flat
  at $\ell$ by theorem~\ref{good_reduction_implies_flat}. In the second case the theory of the Tate
   curve shows that the $\ell$-torsion is (up to quadratic twist) an \emph{unramified} extension of
    the trivial character by the cyclotomic character, and furthermore that the extension is 
    controlled
  by the $\ell$th power of an $\ell$-adic unit. This extension is known to be finite and flat;
  see for example Proposition~8.2 of~\cite{edix}.
\end{proof}

We have now proved the first main result of this chapter.

\begin{theorem}\label{frey_curve_hardly_ramified} Let $\rho$ be the Galois representation on the 
  $\ell$-torsion of the Frey curve coming from a Frey package $(a,b,c,\ell)$. Then $\rho$ is hardly 
  ramified.
\end{theorem}
\begin{proof}
  This follows from the results above. The fact that $\ell\geq 5$ follows from the definition of
  a Frey package. The first condition is theorem~\ref{Elliptic_curve_det_n_torsion},
  and the second is theorem~\ref{frey_curve_unramified}. The third condition is
  theorem~\ref{frey_curve_at_2}, and the fourth is theorem~\ref{Frey_curve_mod_ell_rep_at_ell}.
\end{proof}

\section{The l-torsion in the Frey curve is irreducible.}

We finish this chapter by showing that Mazur's theorem implies that the $\ell$-torsion in the Frey
 curve is irreducible.

Let $(a,b,c,\ell)$ be a Frey package, with associated Frey curve $E$ and mod $\ell$ Galois
 representation $\rho=E[\ell]$. We know that $\rho$ is 2-dimensional; let's suppose that it is
 reducible, so in particular its semisimplification is the direct sum of two characters $\alpha$
 and $\beta$.

 The next two results are Lemme 6 on p307 of~\cite{serrepropgal}.

\begin{theorem}\label{Frey_characters_are_unramified} With notation as above, the characters
  $\alpha$ and $\beta$ are unramified at $p$ for all primes $p\not=\ell$.
\end{theorem}
\begin{proof} We have seen in theorem~\ref{frey_curve_unramified} that $\rho$ is unramified at all 
  primes $p\not=2,\ell$, so the
  characters $\alpha$ and $\beta$ are unramified at all such primes. If $p=2$ then the
  semisimplification of the restriction of $\rho$ to $\Gal(\Qbar_2/\Q_2)$ is unramified
  by corollary~\ref{frey_curve_at_2}, so $\alpha$ and $\beta$ are unramified at 2.
\end{proof}

\begin{theorem}\label{Frey_characters_at_ell} One of $\alpha$ and $\beta$ is unramified at $\ell$.
\end{theorem}
\begin{proof}
In the multiplicative case this follows immediately from the theory of the Tate curve.
In the good reduction case, the $\ell$-torsion is finite and flat at $\ell$ by theorem~\ref{Frey_curve_mod_ell_rep_at_ell}, so we now need to understand what such representations
look like. If the reduction is supersingular, then $\rho$ is necessarily irreducible,
contradicting our assumption. If however the reduction is ordinary, then the theory of the
canonical subgroup shows that the $\ell$-torsion is an extension of an unramified character by
an unramified twist of the cyclotomic character (see Proposition 11 on p273 of~\cite{serrepropgal}).
\end{proof}

As a consequence, one of $\alpha$ and $\beta$ is a character unramified at all primes, and hence
cuts out an extension unramified at all primes, so by Minkowski's theorem this character
is trivial. Because the determinant of $\rho$ is the cyclotomic character, the other character
must be the cyclotomic character.

We know $\rho$ is reducible, so it has a 1-dimensional Galois-invariant submodule, on which
Galois acts by either $\alpha$ or $\beta$. If the action is trivial then $E[\ell]$ has a 
nontrivial Galois-stable element, corresponding to a non-trivial point of order $\ell$.
Put together with the fact that the Frey curve has three points of order 2, this shows
that the torsion in the Frey curve has size at least $4\ell\geq20$, contradicting 
Mazur's theorem~\cite{mazur} that the torsion in any elliptic curve over $\Q$ is bounded
by 16.

If however Galois acts on submodule via the cyclotomic character, then we would like
to quotient out the elliptic curve by this finite Galois-stable submodule, obtaining a second
elliptic curve over $\Q$, and then we can apply
the same argument to this quotient curve (which will also have three points of order 2, namely
the images of the three 2-torsion points in the Frey cure). Constructing the quotient
can be done in several ways. We suggest one method here.

\begin{theorem}\label{Elliptic_curve_quotient_by_finite_subgroup} If $p$ is a prime and
  if $E$ is an elliptic curve over a field $K$ of characteristic not equal to $p$,
   and if $C\subseteq E[p]$ is a Galois-stable
  subgroup of order $p$, then there's an elliptic curve ``''$E/C$'' over $K$ and an isogeny of elliptic curves $E\to E/C$ with kernel precisely $C$.
\end{theorem}
\begin{proof}
  Brian Conrad suggested the following approach, applicable as well for abelian schemes $A\to S$ 
  over a base.  Let $G$ be a finite locally free $S$-subgroup of $A$, say $G$ with constant 
  rank $n > 0$ by working locally on the base, so $G$ is contained in $A[n]$.  Then 
  $n: A \to A$ is the fppf quotient of the source by $A[n]$, so it expresses $A$ as an 
  $A[n]$-torsor over itself.  The problem of building $A/G$ as an abelian scheme is then 
  seen to be the “same” as that of constructing the quotient of this $A[n]$-torsor by the G-action.

  In other words, the problem them becomes one having nothing specific to do with abelian schemes, 
  at the cost of working over a base (such as the original target $A$) even when $S$ was the 
  spectrum of a field in the application. The question is now: for a finite locally free 
  commutative $S$-group $H$ and a closed locally free $S$-subgroup $G$, build a reasonable quotient 
  $H/G$. One approach is to look at the Cartier dual $H^\vee\to G^\vee$, show that it's faithfully 
  flat, and then deduce that the Cartier dual of the kernel of this map does the job. Note that 
  one input for this proof is the claim that inclusions of Hopf algebras over fields are flat, 
  proved nicely in Waterhouse’s book.
\end{proof}

There is surely a more low-level approach to this. Note also that this approach will not
give us a plane cubic, but rather a smooth proper group scheme so we would need Riemann-Roch
to turn it into a plane cubic, although it's unlikely that one will be able to prove Mazur's
theorem without developing all of this machinery and much more, so my instinct is to leave
this for now.

%\begin{theorem}\label{i_am_not_going_to_give_any_uses} A hardly ramified mod $p$ Galois representation $\rho:\GQ\to\GL_2(\Z/p\Z)$ is \emph{potentially automorphic}, becoming automorphic over a (possibly non-solvable) totally real Galois extension $F/\Q$ which is disjoint from the subfield cut out by the kernel of $\rho$.
%\end{theorem}
% Thm 5.3 Taylor notes
%\begin{proof}
%  This proof is deep. There are three major steps.
%
%  1) We first use Moret-Bailly's theorem to find an F and an F-point $A/F$ on a moduli space of elliptic curves with $p$-torsion $\rho$ and $\ell$-torsion induced from a certain character.
%
%  2) We then lift the character to characteristic zero, and prove that the resulting theta series is modular (using for example a converse theorem). We deduce that $A[\ell]$ is modular.
%
%  3) We now use a modularity lifting theorem (due to Wiles/Taylor/Khare-Wintenberger/Skinner-Wiles/who?) to deduce that $A$ is modular. We immediately deduce that $A[p]$ is modular as required.
%\end{proof}

